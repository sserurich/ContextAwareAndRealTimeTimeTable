/*
Deployment script for ContextAwareAndRealTimeTimeTable

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "ContextAwareAndRealTimeTimeTable"
:setvar DefaultFilePrefix "ContextAwareAndRealTimeTimeTable"
:setvar DefaultDataPath "c:\Program Files\Microsoft SQL Server\MSSQL11.SQLEXPRESS2012\MSSQL\DATA\"
:setvar DefaultLogPath "c:\Program Files\Microsoft SQL Server\MSSQL11.SQLEXPRESS2012\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT LOCAL,
                RECOVERY FULL 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping [dbo].[AspNetUserClaims].[IX_UserId]...';


GO
DROP INDEX [IX_UserId]
    ON [dbo].[AspNetUserClaims];


GO
PRINT N'Dropping [dbo].[AspNetRoles].[RoleNameIndex]...';


GO
DROP INDEX [RoleNameIndex]
    ON [dbo].[AspNetRoles];


GO
PRINT N'Dropping [dbo].[AspNetUserLogins].[IX_UserId]...';


GO
DROP INDEX [IX_UserId]
    ON [dbo].[AspNetUserLogins];


GO
PRINT N'Dropping [dbo].[AspNetUserRoles].[IX_RoleId]...';


GO
DROP INDEX [IX_RoleId]
    ON [dbo].[AspNetUserRoles];


GO
PRINT N'Dropping [dbo].[AspNetUserRoles].[IX_UserId]...';


GO
DROP INDEX [IX_UserId]
    ON [dbo].[AspNetUserRoles];


GO
PRINT N'Dropping [dbo].[AspNetUsers].[UserNameIndex]...';


GO
DROP INDEX [UserNameIndex]
    ON [dbo].[AspNetUsers];


GO
PRINT N'Dropping FK_dbo.AspNetUserClaims_dbo.AspNetUsers_UserId...';


GO
ALTER TABLE [dbo].[AspNetUserClaims] DROP CONSTRAINT [FK_dbo.AspNetUserClaims_dbo.AspNetUsers_UserId];


GO
PRINT N'Dropping FK_dbo.AspNetUserLogins_dbo.AspNetUsers_UserId...';


GO
ALTER TABLE [dbo].[AspNetUserLogins] DROP CONSTRAINT [FK_dbo.AspNetUserLogins_dbo.AspNetUsers_UserId];


GO
PRINT N'Altering [dbo].[AspNetUserClaims]...';


GO
ALTER TABLE [dbo].[AspNetUserClaims] ALTER COLUMN [UserId] NVARCHAR (MAX) NULL;


GO
ALTER TABLE [dbo].[AspNetUserClaims]
    ADD [IdentityUser_Id] NVARCHAR (128) NULL;


GO
PRINT N'Altering [dbo].[AspNetUserLogins]...';


GO
ALTER TABLE [dbo].[AspNetUserLogins]
    ADD [IdentityUser_Id] NVARCHAR (128) NULL;


GO
PRINT N'Creating [dbo].[Activity]...';


GO
CREATE TABLE [dbo].[Activity] (
    [ActivityId] INT          IDENTITY (1, 1) NOT NULL,
    [Name]       VARCHAR (50) NULL,
    [GroupId]    INT          NOT NULL,
    [LecturerId] INT          NOT NULL,
    [DayId]      INT          NOT NULL,
    [RoomId]     INT          NOT NULL,
    [StartTime]  VARCHAR (50) NOT NULL,
    [EndTime]    VARCHAR (50) NOT NULL,
    [CreatedOn]  DATETIME     NOT NULL,
    [UpdatedOn]  DATETIME     NULL,
    [DeletedOn]  DATETIME     NULL,
    CONSTRAINT [PK_dbo.Activity] PRIMARY KEY CLUSTERED ([ActivityId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Comment]...';


GO
CREATE TABLE [dbo].[Comment] (
    [CommentId]   INT           IDENTITY (1, 1) NOT NULL,
    [Description] VARCHAR (MAX) NOT NULL,
    [ActivityId]  INT           NOT NULL,
    [CreatedBy]   INT           NOT NULL,
    [CreatedOn]   DATETIME      NOT NULL,
    [UpdatedOn]   DATETIME      NULL,
    [DeletedOn]   DATETIME      NULL,
    CONSTRAINT [PK_Comment] PRIMARY KEY CLUSTERED ([CommentId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Day]...';


GO
CREATE TABLE [dbo].[Day] (
    [DayId]     INT          IDENTITY (1, 1) NOT NULL,
    [Name]      VARCHAR (50) NOT NULL,
    [CreatedOn] DATETIME     NOT NULL,
    [UpdatedOn] DATETIME     NULL,
    [DeletedOn] DATETIME     NULL,
    CONSTRAINT [PK_dbo.Day] PRIMARY KEY CLUSTERED ([DayId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Group]...';


GO
CREATE TABLE [dbo].[Group] (
    [GroupId]   INT          IDENTITY (1, 1) NOT NULL,
    [Name]      VARCHAR (50) NOT NULL,
    [CreatedOn] DATETIME     NOT NULL,
    [UpdatedOn] DATETIME     NULL,
    [DeletedOn] DATETIME     NULL,
    CONSTRAINT [PK_dbo.Group] PRIMARY KEY CLUSTERED ([GroupId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[GroupActivity]...';


GO
CREATE TABLE [dbo].[GroupActivity] (
    [GroupActivityId] INT      IDENTITY (1, 1) NOT NULL,
    [ActivityId]      INT      NOT NULL,
    [GroupId]         INT      NOT NULL,
    [CreatedOn]       DATETIME NOT NULL,
    [UpdatedOn]       DATETIME NULL,
    [DeletedOn]       DATETIME NULL,
    CONSTRAINT [PK_dbo.GroupActivity] PRIMARY KEY CLUSTERED ([GroupActivityId] ASC, [ActivityId] ASC, [GroupId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Lecturer]...';


GO
CREATE TABLE [dbo].[Lecturer] (
    [LecturerId]     INT            IDENTITY (1, 1) NOT NULL,
    [EmployeeNumber] VARCHAR (50)   NOT NULL,
    [UserId]         NVARCHAR (128) NOT NULL,
    [CreatedOn]      DATETIME       NOT NULL,
    [UpdatedOn]      DATETIME       NULL,
    [DeletedOn]      DATETIME       NULL,
    CONSTRAINT [PK_dbo.Lecturer] PRIMARY KEY CLUSTERED ([LecturerId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Room]...';


GO
CREATE TABLE [dbo].[Room] (
    [RoomId]    INT          IDENTITY (1, 1) NOT NULL,
    [Name]      VARCHAR (50) NOT NULL,
    [CreatedOn] DATETIME     NOT NULL,
    [UpdatedOn] DATETIME     NULL,
    [DeletedOn] DATETIME     NULL,
    CONSTRAINT [PK_dbo.Room] PRIMARY KEY CLUSTERED ([RoomId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Student]...';


GO
CREATE TABLE [dbo].[Student] (
    [StudentId]          INT            IDENTITY (1, 1) NOT NULL,
    [StudentNumber]      VARCHAR (50)   NOT NULL,
    [RegistrationNumber] VARCHAR (50)   NOT NULL,
    [UserId]             NVARCHAR (128) NOT NULL,
    [CreatedOn]          DATETIME       NOT NULL,
    [UpdatedOn]          DATETIME       NULL,
    [DeletedOn]          DATETIME       NULL,
    CONSTRAINT [PK_dbo.Student] PRIMARY KEY CLUSTERED ([StudentId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[StudentGroup]...';


GO
CREATE TABLE [dbo].[StudentGroup] (
    [StudentGroupId] INT      IDENTITY (1, 1) NOT NULL,
    [StudentId]      INT      NOT NULL,
    [GroupId]        INT      NOT NULL,
    [CreatedOn]      DATETIME NOT NULL,
    [UpdatedOn]      DATETIME NULL,
    [DeletedOn]      DATETIME NULL,
    CONSTRAINT [PK_dbo.StudentGroup] PRIMARY KEY CLUSTERED ([StudentGroupId] ASC, [StudentId] ASC, [GroupId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[StudentSubject]...';


GO
CREATE TABLE [dbo].[StudentSubject] (
    [StudentSubjectId] INT      IDENTITY (1, 1) NOT NULL,
    [StudentId]        INT      NOT NULL,
    [SubjectId]        INT      NOT NULL,
    [CreatedOn]        DATETIME NOT NULL,
    [UpdatedOn]        DATETIME NULL,
    [DeletedOn]        DATETIME NULL,
    CONSTRAINT [PK_dbo.StudentSubject] PRIMARY KEY CLUSTERED ([StudentSubjectId] ASC, [StudentId] ASC, [SubjectId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[StudentYear]...';


GO
CREATE TABLE [dbo].[StudentYear] (
    [StudentYearId] INT      IDENTITY (1, 1) NOT NULL,
    [StudentId]     INT      NOT NULL,
    [YearId]        INT      NOT NULL,
    [CreatedOn]     DATETIME NOT NULL,
    [UpdatedOn]     DATETIME NULL,
    [DeletedOn]     DATETIME NULL,
    CONSTRAINT [PK_dbo.StudentYear] PRIMARY KEY CLUSTERED ([StudentYearId] ASC, [StudentId] ASC, [YearId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Subject]...';


GO
CREATE TABLE [dbo].[Subject] (
    [SubjectId] INT          IDENTITY (1, 1) NOT NULL,
    [Name]      VARCHAR (50) NOT NULL,
    [CreatedOn] DATETIME     NOT NULL,
    [UpdatedOn] DATETIME     NULL,
    [DeletedOn] DATETIME     NULL,
    CONSTRAINT [PK_dbo.Subject] PRIMARY KEY CLUSTERED ([SubjectId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Year]...';


GO
CREATE TABLE [dbo].[Year] (
    [YearId]    INT          IDENTITY (1, 1) NOT NULL,
    [Name]      VARCHAR (50) NOT NULL,
    [CreatedOn] DATETIME     NOT NULL,
    [UpdatedOn] DATETIME     NULL,
    [DeletedOn] DATETIME     NULL,
    CONSTRAINT [PK_dbo.Year] PRIMARY KEY CLUSTERED ([YearId] ASC)
) ON [PRIMARY];


GO
PRINT N'Creating Fk_dbo_Activity_dbo_Lecturer_LecturerId...';


GO
ALTER TABLE [dbo].[Activity] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_Activity_dbo_Lecturer_LecturerId] FOREIGN KEY ([LecturerId]) REFERENCES [dbo].[Lecturer] ([LecturerId]);


GO
PRINT N'Creating Fk_dbo_Activity_dbo_Group_GroupId...';


GO
ALTER TABLE [dbo].[Activity] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_Activity_dbo_Group_GroupId] FOREIGN KEY ([GroupId]) REFERENCES [dbo].[Group] ([GroupId]);


GO
PRINT N'Creating Fk_dbo_Activity_dbo_Room_RoomId...';


GO
ALTER TABLE [dbo].[Activity] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_Activity_dbo_Room_RoomId] FOREIGN KEY ([RoomId]) REFERENCES [dbo].[Room] ([RoomId]);


GO
PRINT N'Creating Fk_dbo_Comment_dbo_Lecturer_CreatedBy...';


GO
ALTER TABLE [dbo].[Comment] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_Comment_dbo_Lecturer_CreatedBy] FOREIGN KEY ([CreatedBy]) REFERENCES [dbo].[Lecturer] ([LecturerId]);


GO
PRINT N'Creating Fk_dbo_Comment_dbo_Activity_ActivityId...';


GO
ALTER TABLE [dbo].[Comment] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_Comment_dbo_Activity_ActivityId] FOREIGN KEY ([ActivityId]) REFERENCES [dbo].[Activity] ([ActivityId]);


GO
PRINT N'Creating Fk_dbo_GroupActivity_dbo_Group_GroupId...';


GO
ALTER TABLE [dbo].[GroupActivity] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_GroupActivity_dbo_Group_GroupId] FOREIGN KEY ([GroupId]) REFERENCES [dbo].[Group] ([GroupId]);


GO
PRINT N'Creating Fk_dbo_GroupActivity_dbo_Activity_ActivityId...';


GO
ALTER TABLE [dbo].[GroupActivity] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_GroupActivity_dbo_Activity_ActivityId] FOREIGN KEY ([ActivityId]) REFERENCES [dbo].[Activity] ([ActivityId]);


GO
PRINT N'Creating Fk_dbo_Lecturer_dbo_AspNetUsers_Id...';


GO
ALTER TABLE [dbo].[Lecturer] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_Lecturer_dbo_AspNetUsers_Id] FOREIGN KEY ([UserId]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Fk_dbo_Student_dbo_AspNetUsers_Id...';


GO
ALTER TABLE [dbo].[Student] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_Student_dbo_AspNetUsers_Id] FOREIGN KEY ([UserId]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Fk_dbo_StudentGroup_dbo_Group_GroupId...';


GO
ALTER TABLE [dbo].[StudentGroup] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_StudentGroup_dbo_Group_GroupId] FOREIGN KEY ([GroupId]) REFERENCES [dbo].[Group] ([GroupId]);


GO
PRINT N'Creating Fk_dbo_StudentGroup_dbo_Student_StudentId...';


GO
ALTER TABLE [dbo].[StudentGroup] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_StudentGroup_dbo_Student_StudentId] FOREIGN KEY ([StudentId]) REFERENCES [dbo].[Student] ([StudentId]);


GO
PRINT N'Creating Fk_dbo_StudentSubject_dbo_Subject_SubjectId...';


GO
ALTER TABLE [dbo].[StudentSubject] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_StudentSubject_dbo_Subject_SubjectId] FOREIGN KEY ([SubjectId]) REFERENCES [dbo].[Subject] ([SubjectId]);


GO
PRINT N'Creating Fk_dbo_StudentSubject_dbo_Student_StudentId...';


GO
ALTER TABLE [dbo].[StudentSubject] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_StudentSubject_dbo_Student_StudentId] FOREIGN KEY ([StudentId]) REFERENCES [dbo].[Student] ([StudentId]);


GO
PRINT N'Creating Fk_dbo_StudentYear_dbo_year_YearId...';


GO
ALTER TABLE [dbo].[StudentYear] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_StudentYear_dbo_year_YearId] FOREIGN KEY ([YearId]) REFERENCES [dbo].[Year] ([YearId]);


GO
PRINT N'Creating Fk_dbo_StudentYear_dbo_Student_StudentId...';


GO
ALTER TABLE [dbo].[StudentYear] WITH NOCHECK
    ADD CONSTRAINT [Fk_dbo_StudentYear_dbo_Student_StudentId] FOREIGN KEY ([StudentId]) REFERENCES [dbo].[Student] ([StudentId]);


GO
PRINT N'Creating FK_dbo.AspNetUserClaims_dbo.AspNetUsers_IdentityUser_Id...';


GO
ALTER TABLE [dbo].[AspNetUserClaims] WITH NOCHECK
    ADD CONSTRAINT [FK_dbo.AspNetUserClaims_dbo.AspNetUsers_IdentityUser_Id] FOREIGN KEY ([IdentityUser_Id]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Creating FK_dbo.AspNetUserLogins_dbo.AspNetUsers_IdentityUser_Id...';


GO
ALTER TABLE [dbo].[AspNetUserLogins] WITH NOCHECK
    ADD CONSTRAINT [FK_dbo.AspNetUserLogins_dbo.AspNetUsers_IdentityUser_Id] FOREIGN KEY ([IdentityUser_Id]) REFERENCES [dbo].[AspNetUsers] ([Id]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Activity] WITH CHECK CHECK CONSTRAINT [Fk_dbo_Activity_dbo_Lecturer_LecturerId];

ALTER TABLE [dbo].[Activity] WITH CHECK CHECK CONSTRAINT [Fk_dbo_Activity_dbo_Group_GroupId];

ALTER TABLE [dbo].[Activity] WITH CHECK CHECK CONSTRAINT [Fk_dbo_Activity_dbo_Room_RoomId];

ALTER TABLE [dbo].[Comment] WITH CHECK CHECK CONSTRAINT [Fk_dbo_Comment_dbo_Lecturer_CreatedBy];

ALTER TABLE [dbo].[Comment] WITH CHECK CHECK CONSTRAINT [Fk_dbo_Comment_dbo_Activity_ActivityId];

ALTER TABLE [dbo].[GroupActivity] WITH CHECK CHECK CONSTRAINT [Fk_dbo_GroupActivity_dbo_Group_GroupId];

ALTER TABLE [dbo].[GroupActivity] WITH CHECK CHECK CONSTRAINT [Fk_dbo_GroupActivity_dbo_Activity_ActivityId];

ALTER TABLE [dbo].[Lecturer] WITH CHECK CHECK CONSTRAINT [Fk_dbo_Lecturer_dbo_AspNetUsers_Id];

ALTER TABLE [dbo].[Student] WITH CHECK CHECK CONSTRAINT [Fk_dbo_Student_dbo_AspNetUsers_Id];

ALTER TABLE [dbo].[StudentGroup] WITH CHECK CHECK CONSTRAINT [Fk_dbo_StudentGroup_dbo_Group_GroupId];

ALTER TABLE [dbo].[StudentGroup] WITH CHECK CHECK CONSTRAINT [Fk_dbo_StudentGroup_dbo_Student_StudentId];

ALTER TABLE [dbo].[StudentSubject] WITH CHECK CHECK CONSTRAINT [Fk_dbo_StudentSubject_dbo_Subject_SubjectId];

ALTER TABLE [dbo].[StudentSubject] WITH CHECK CHECK CONSTRAINT [Fk_dbo_StudentSubject_dbo_Student_StudentId];

ALTER TABLE [dbo].[StudentYear] WITH CHECK CHECK CONSTRAINT [Fk_dbo_StudentYear_dbo_year_YearId];

ALTER TABLE [dbo].[StudentYear] WITH CHECK CHECK CONSTRAINT [Fk_dbo_StudentYear_dbo_Student_StudentId];

ALTER TABLE [dbo].[AspNetUserClaims] WITH CHECK CHECK CONSTRAINT [FK_dbo.AspNetUserClaims_dbo.AspNetUsers_IdentityUser_Id];

ALTER TABLE [dbo].[AspNetUserLogins] WITH CHECK CHECK CONSTRAINT [FK_dbo.AspNetUserLogins_dbo.AspNetUsers_IdentityUser_Id];


GO
PRINT N'Update complete.';


GO
